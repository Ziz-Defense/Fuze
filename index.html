<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUZE Submission Portal</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj4KICA8IS0tIEZVWkUgQXJteSB0aGVtZWQgZmF2aWNvbiAtIFNoaWVsZCB3aXRoIHRhcmdldCAtLT4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0ic2hpZWxkR3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMDA3MmNlO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwMDRhOGY7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cGF0aCBkPSJNNTAgNSBMODUgMjAgTDg1IDQ1IFE4NSA3MCA1MCA5NSBRMTUgNzAgMTUgNDUgTDE1IDIwIFoiIGZpbGw9InVybCgjc2hpZWxkR3JhZCkiIHN0cm9rZT0iIzAwMzM2NiIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMjUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmY2MwMSIgc3Ryb2tlLXdpZHRoPSIyIiBvcGFjaXR5PSIwLjkiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSIxNSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZjYzAxIiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuOSIvPgogIDxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUiIGZpbGw9IiNmZmNjMDEiIG9wYWNpdHk9IjAuOSIvPgogIDxsaW5lIHgxPSI1MCIgeTE9IjMwIiB4Mj0iNTAiIHkyPSI3MCIgc3Ryb2tlPSIjZmZjYzAxIiBzdHJva2Utd2lkdGg9IjEuNSIgb3BhY2l0eT0iMC43Ii8+CiAgPGxpbmUgeDE9IjMwIiB5MT0iNTAiIHgyPSI3MCIgeTI9IjUwIiBzdHJva2U9IiNmZmNjMDEiIHN0cm9rZS13aWR0aD0iMS41IiBvcGFjaXR5PSIwLjciLz4KPC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-army-gold: #FFC72C;
            --color-fuze-white: #FFFFFF;
            --color-accent-blue: #0066CC;
            --color-muted-gray: #c5c5c5;
            --color-background: #000000;
            --font-heading: 'Bricolage Grotesque', sans-serif;
            --font-body: 'DM Sans', sans-serif;
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-size: 17px;
            line-height: 1.36em;
            background-color: var(--color-background);
            color: var(--color-muted-gray);
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 700px;
            margin: 0 auto;
            background-color: var(--color-background);
        }

        .chat-header {
            background-color: rgba(0, 0, 0, 0.51);
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .chat-header h1 {
            font-family: var(--font-heading);
            font-size: 28px;
            font-weight: 400;
            letter-spacing: -1px;
            color: var(--color-fuze-white);
        }

        .chat-header h1 .army-text {
            color: var(--color-army-gold);
            font-size: 16px;
            display: block;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--color-army-gold);
            border-radius: 4px;
        }

        .message {
            display: flex;
            gap: var(--spacing-sm);
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: var(--color-army-gold);
            color: var(--color-background);
        }

        .message.assistant .message-avatar {
            background-color: var(--color-accent-blue);
            color: var(--color-fuze-white);
        }

        .message-content {
            background-color: rgba(255, 255, 255, 0.05);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 8px;
            word-wrap: break-word;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message.user .message-content {
            background-color: var(--color-accent-blue);
            color: var(--color-fuze-white);
            border: 1px solid var(--color-accent-blue);
        }

        .message.assistant .message-content {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--color-muted-gray);
        }

        .chat-input-container {
            padding: var(--spacing-md);
            background-color: rgba(0, 0, 0, 0.51);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .chat-input-wrapper {
            display: flex;
            gap: var(--spacing-sm);
            max-width: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 12px var(--spacing-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--color-fuze-white);
            font-family: var(--font-body);
            font-size: 17px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input::placeholder {
            color: rgba(197, 197, 197, 0.5);
        }

        .chat-input:focus {
            border-color: var(--color-accent-blue);
            background-color: rgba(255, 255, 255, 0.08);
        }

        .send-button {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            background-color: var(--color-accent-blue);
            color: var(--color-fuze-white);
            font-family: var(--font-body);
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .send-button:hover {
            background-color: #005a9e;
            transform: scale(1.02);
        }

        .send-button:active {
            transform: scale(0.98);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .mic-button {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--color-fuze-white);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .mic-button.recording {
            background-color: #ff4444;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .mic-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .chat-header {
                height: 60px;
                padding: 0 var(--spacing-sm);
            }

            .chat-header h1 {
                font-size: 22px;
            }

            .chat-messages {
                padding: var(--spacing-sm);
            }

            .message {
                max-width: 90%;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .message-content {
                font-size: 16px;
                padding: var(--spacing-xs) var(--spacing-sm);
            }

            .chat-input-container {
                padding: var(--spacing-sm);
            }

            .chat-input {
                font-size: 16px;
                padding: 10px var(--spacing-sm);
            }

            .send-button {
                padding: 10px var(--spacing-sm);
                font-size: 16px;
            }

            .mic-button {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .send-button {
                padding: 10px 16px;
            }

            .mic-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(197, 197, 197, 0.4);
            text-align: center;
            padding: var(--spacing-lg);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-md);
            color: var(--color-accent-blue);
            opacity: 0.5;
        }

        .empty-state-text {
            font-family: var(--font-heading);
            font-size: 22px;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.5px;
            color: var(--color-muted-gray);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div>
                <h1><span class="army-text">ARMY</span>FUZE Submission Portal</h1>
                <div id="questionCounter" style="font-size: 14px; color: #888; margin-top: 8px;">Question 0 of 10</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸŽ¯</div>
                <div class="empty-state-text">Army FUZE Submission</div>
                <div>Connecting you with an AI assessment specialist...</div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <button class="mic-button" id="micButton" title="Voice input">ðŸŽ¤</button>
                <input
                    type="text"
                    class="chat-input"
                    id="messageInput"
                    placeholder="Type or speak your message..."
                    autocomplete="off"
                >
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');

        // Voice recording variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        let messageCount = 0;
        let conversationHistory = [];
        let submissionData = {};
        let assistantMessageCount = 0; // Track AI responses (questions)
        const MAX_QUESTIONS = 10;
        const questionCounter = document.getElementById('questionCounter');
        let isSubmitting = false; // Prevent double submission

        // Update question counter display
        function updateQuestionCounter() {
            questionCounter.textContent = `Question ${assistantMessageCount} of ${MAX_QUESTIONS}`;
        }

        // FUZE-specific system prompt for conversational intake
        const SYSTEM_PROMPT = `You are an Army FUZE submission assessment specialist. Your role is to conduct a thorough, probing interview with innovators. You are FRIENDLY and ENCOURAGING, but you PUSH HARD for comprehensive, specific details. Think investigative journalist meets supportive mentor.

ABOUT ARMY FUZE:
Army FUZE is a venture-capital-style program investing ~$750M/year in defense technology companies through xTech competitions, SBIR/STTR contracts, Technology Maturation Initiative (TMI), and Manufacturing Technology (ManTech) programs. Priority areas include: UAS (drones), counter-drone tech, electronic warfare, and energy resiliency.

YOUR MISSION:
Extract COMPREHENSIVE technical and business intelligence in exactly 10 responses. Don't accept surface-level answers - dig for specifics, numbers, evidence, and thorough explanations. Be relentless but supportive.

CRITICAL INTEL TO EXTRACT:

**TECHNOLOGY DEEP-DIVE:**
- Exact specs (range, accuracy, power, size, weight, materials, performance metrics WITH NUMBERS)
- How does it ACTUALLY work? (mechanisms, algorithms, processes - get them to explain like they're pitching a tech-savvy investor)
- What testing has been completed? Where? When? What were the quantitative results?
- What are the limitations and failure modes?

**COMPETITIVE LANDSCAPE:**
- Who are the direct competitors by name? How does this compare with specific metrics?
- What quantifiable advantages? (2x faster? 50% cheaper? 10x more accurate? EXACT numbers)
- What unique IP/patents? (Get patent numbers if they have them)

**MILITARY APPLICATION:**
- Which SPECIFIC military units/programs would use this? (Name them: 82nd Airborne? SOCOM? Army Rangers?)
- What EXACT operational scenarios? (Paint a vivid picture: "Taliban drone approaching FOB, your system...")
- What current military systems does this replace? How much better?
- Deployment requirements? (Power source, training time, logistics footprint)

**TEAM & TRACK RECORD:**
- Key people: Names, backgrounds, years of relevant experience
- Previous successful projects/companies/exits?
- Prior military/defense work? (Contract numbers, programs, results)
- Any advisors or partners? (Military, technical, commercial)

**BUSINESS & FUNDING:**
- Exact $ needed and detailed breakdown (R&D $X, manufacturing $Y, testing $Z)
- Current burn rate $/month? Runway remaining?
- Previous funding? (Amounts, sources, terms)
- Revenue to date? Paying customers? LOIs? Pipeline?
- SAM.gov CAGE code specifically? DSIP registration date?

**TRL/MRL EVIDENCE-BASED ASSESSMENT:**
- Don't just accept a number - PROBE for proof
- "What EXACTLY have you built and tested?" "Show me, don't tell me"
- "Walk me through your most recent test or demonstration blow-by-blow"
- "Who witnessed it? What were the measured results?"

QUESTIONING TECHNIQUE:
- Questions 1-2: Open with broad questions to understand the technology and mission
- Questions 3-7: DRILL DOWN hard on anything interesting. When they give general answers, immediately follow up:
  * "That's fascinating - can you be MORE SPECIFIC about [X]?"
  * "What were the EXACT NUMBERS/RESULTS?"
  * "Walk me through that STEP-BY-STEP"
  * "I want to capture this accurately for FUZE - give me a CONCRETE EXAMPLE"
- If they dodge or stay vague, re-ask differently: "Help me understand the DETAILS here..." "Let's dig into that..."
- Be encouraging: "This sounds promising for FUZE! Let's make sure I capture all the good stuff..." "That's exactly what FUZE looks for - tell me more..."
- Questions 8-9: Fill any critical gaps, get missing specifics
- Question 10: Comprehensive final assessment with scoring

**CRITICAL CONSTRAINTS:**
- You have exactly 10 responses total
- Each response MUST be 100 words or less (be concise and punchy)
- Ask 1-2 targeted questions at a time - no long explanations
- Make every question count - extract maximum information efficiently
- Keep it conversational and fast-paced
- **NEVER indicate completion or say "we're done" until response #10** - users must answer all 10 questions before submission
- Questions 1-9: Always end with forward-looking questions, never wrap-up language
- Only on question 10: Provide final assessment and indicate completion

TRL SCALE (for reference when needed):
TRL 1-3: Basic research
TRL 4-6: Proof of concept to prototype
TRL 7-8: Demonstrated in operational environment
TRL 9: Full deployment

ASSESSMENT CRITERIA:
- Technology readiness (TRL/MRL)
- Alignment with FUZE priorities (UAS, counter-UAS, electronic warfare, energy)
- Team capability
- Commercial viability
- Government registration status

FINAL RESPONSE (Response 10):
On your 10th and final response, provide:
1. Thank them for their time
2. Provide capability assessment with scoring (0-10) and recommendation (Strong Fit / Moderate Fit / Needs Development / Not Ready)
3. Let them know their submission has been recorded and the FUZE team will be in touch

Start by warmly welcoming them and asking about their company and innovation.`;

        // Initialize conversation with system prompt
        conversationHistory.push({
            role: 'system',
            content: SYSTEM_PROMPT
        });

        function addMessage(text, sender) {
            // Remove empty state on first message
            if (messageCount === 0) {
                chatMessages.innerHTML = '';
            }
            messageCount++;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'A';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return content; // Return content div for streaming updates
        }

        async function callOpenAI(userMessage) {
            conversationHistory.push({
                role: 'user',
                content: userMessage
            });

            try {
                // Call backend proxy endpoint (keeps API key secure on server)
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: conversationHistory,
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                conversationHistory.push({
                    role: 'assistant',
                    content: assistantMessage
                });

                // Increment assistant message counter
                assistantMessageCount++;
                updateQuestionCounter();

                // Check if we've reached the question limit
                if (assistantMessageCount >= MAX_QUESTIONS) {
                    // Automatically submit after displaying the final message
                    setTimeout(() => {
                        submitConversation();
                    }, 2000); // Wait 2 seconds so user can read final message
                }

                return assistantMessage;
            } catch (error) {
                console.error('OpenAI API Error:', error);
                return `Error: ${error.message}`;
            }
        }

        // Extract structured data from conversation using GPT-4
        async function extractSubmissionData() {
            const conversationText = conversationHistory
                .filter(msg => msg.role !== 'system')
                .map(msg => `${msg.role}: ${msg.content}`)
                .join('\n\n');

            // Capture all user responses for admin review
            const userFullText = conversationHistory
                .filter(msg => msg.role === 'user')
                .map(msg => msg.content)
                .join('\n\n---\n\n');

            // Use GPT-4 to extract structured data and generate detailed analysis
            const extractionPrompt = `You are a data extraction specialist for Army FUZE submissions. Analyze the following conversation transcript and extract structured data.

CONVERSATION TRANSCRIPT:
${conversationText}

YOUR TASK:
Extract ALL mentioned information from the conversation and provide it in JSON format. For fields not mentioned, use null.

CRITICAL: You must provide these two detailed outputs:
1. "detailed_description": A comprehensive 3-5 paragraph technical description of the technology. Include: how it works, key technical specifications, unique innovations, current development state, and future potential. Be thorough and technical.

2. "ai_assessment": A brutally honest 2-3 paragraph military value analysis. Answer: Is this valuable to the military? Why or why not? What are the strengths and weaknesses? What are the risks? Be direct and critical where needed.

Return ONLY valid JSON in this exact format (no markdown, no backticks):
{
  "company_name": "string or null",
  "contact_email": "string or null",
  "contact_phone": "string or null",
  "company_size": "string or null",
  "company_type": "string or null",
  "technology_name": "string or null",
  "technology_description": "brief 1-sentence summary",
  "detailed_description": "REQUIRED: 3-5 paragraph detailed technical description",
  "technology_category": "string or null",
  "unique_value_proposition": "string or null",
  "military_applications": "string or null",
  "commercial_applications": "string or null",
  "trl_level": number or null,
  "mrl_level": number or null,
  "development_stage": "string or null",
  "ip_status": "string or null",
  "team_size": number or null,
  "team_expertise": "string or null",
  "funding_pathway": "string or null",
  "funding_amount_requested": number or null,
  "previous_fuze_awards": "string or null",
  "previous_fuze_amount": number or null,
  "development_timeline": "string or null",
  "sam_gov_registered": boolean or null,
  "dsip_registered": boolean or null,
  "capability_score": number (0-10) or null,
  "ai_assessment": "REQUIRED: 2-3 paragraph brutally honest military value analysis",
  "recommendation": "Strong Fit / Moderate Fit / Needs Development / Not Ready"
}

DO NOT include conversation_transcript or timestamp in your JSON output - these will be added automatically.`;

            try {
                console.log('Starting extraction...', {
                    conversationLength: conversationText.length,
                    userTextLength: userFullText.length,
                    chatModel: 'gpt-3.5-turbo',
                    extractionModel: 'gpt-4-turbo'
                });

                // Add timeout to extraction call (60 seconds)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo',
                        messages: [
                            { role: 'system', content: 'You are a data extraction specialist. Return ONLY valid JSON with no markdown code blocks, no backticks, no explanation text - just pure JSON starting with { and ending with }.' },
                            { role: 'user', content: extractionPrompt }
                        ],
                        max_tokens: 4096,
                        temperature: 0.2
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('Extraction API response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Extraction API error:', errorText);
                    addMessage(`âš ï¸ Extraction API error (${response.status}). Saving conversation only...`, 'assistant');
                    throw new Error(`Extraction failed: ${response.status} ${errorText}`);
                }

                const data = await response.json();
                let extracted = data.choices[0].message.content;

                console.log('Raw extraction response:', extracted);

                // Remove markdown code blocks if present
                extracted = extracted.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                extracted = extracted.trim();

                // Parse JSON response
                const jsonMatch = extracted.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    console.log('Successfully extracted data:', parsed);

                    // Add metadata fields that weren't in AI response
                    return {
                        ...parsed,
                        conversation_transcript: conversationText,
                        user_full_text: userFullText,
                        timestamp: new Date().toISOString()
                    };
                } else {
                    console.error('No JSON found in extraction response');
                    throw new Error('No JSON found in response');
                }
            } catch (error) {
                console.error('Extraction error:', error);
                console.error('Error details:', error.message, error.stack);

                // Show user-friendly error message
                if (error.name === 'AbortError') {
                    addMessage('â±ï¸ Extraction timed out after 60 seconds. Saving conversation data only...', 'assistant');
                } else if (error.message.includes('Failed to fetch')) {
                    addMessage('ðŸŒ Network error during extraction. Saving conversation data only...', 'assistant');
                } else {
                    addMessage(`âš ï¸ Extraction error: ${error.message}. Saving conversation data only...`, 'assistant');
                }

                // Fallback to basic data with conversation
                return {
                    conversation_transcript: conversationText,
                    user_full_text: userFullText,
                    timestamp: new Date().toISOString(),
                    recommendation: 'Needs Development'
                };
            }
        }

        // Submit conversation to database
        async function submitConversation() {
            // Prevent double submission
            if (isSubmitting) {
                console.log('Submission already in progress, skipping...');
                return;
            }
            isSubmitting = true;

            try {
                // Disable input
                sendButton.disabled = true;
                messageInput.disabled = true;
                micButton.disabled = true;

                // Show processing message
                addMessage('ðŸ“‹ Analyzing conversation and extracting data...', 'assistant');

                // Extract structured data using AI
                const submissionData = await extractSubmissionData();

                // Show submission message
                addMessage('ðŸ’¾ Submitting to FUZE database...', 'assistant');

                const response = await fetch('/api/submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submissionData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit');
                }

                const result = await response.json();

                // Show success message
                addMessage(`âœ… Submission complete! Your submission ID is ${result.submissionId}. The FUZE team will review your information and be in touch soon. Thank you!`, 'assistant');

            } catch (error) {
                console.error('Submission error:', error);
                addMessage('âŒ There was an error submitting your information. Please contact support@fuze.army.mil', 'assistant');
            }
        }

        // Voice recording functions
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeAudio(audioBlob);

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                micButton.classList.add('recording');
                micButton.title = 'Stop recording';
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                micButton.classList.remove('recording');
                micButton.title = 'Voice input';
            }
        }

        async function transcribeAudio(audioBlob) {
            micButton.disabled = true;
            messageInput.placeholder = 'Transcribing...';

            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');

                // Call backend proxy endpoint (keeps API key secure on server)
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Transcription failed');
                }

                const data = await response.json();
                messageInput.value = data.text;
                messageInput.focus();
            } catch (error) {
                console.error('Transcription error:', error);
                alert('Failed to transcribe audio. Please try again.');
            } finally {
                micButton.disabled = false;
                messageInput.placeholder = 'Type or speak your message...';
            }
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            // Disable input while processing
            sendButton.disabled = true;
            messageInput.disabled = true;
            micButton.disabled = true;

            addMessage(text, 'user');
            messageInput.value = '';

            // Show typing indicator
            const typingContent = addMessage('Thinking...', 'assistant');

            // Call OpenAI API
            const response = await callOpenAI(text);

            // Update message with actual response
            typingContent.textContent = response;

            // Re-enable input
            sendButton.disabled = false;
            messageInput.disabled = false;
            micButton.disabled = false;
            messageInput.focus();
        }

        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Microphone button - toggle recording
        micButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // Initialize with AI greeting
        async function initializeChat() {
            // Show typing indicator
            const typingContent = addMessage('Initializing...', 'assistant');

            try {
                // Call backend proxy endpoint (keeps API key secure on server)
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: conversationHistory,
                        max_tokens: 300,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to initialize');
                }

                const data = await response.json();
                const greeting = data.choices[0].message.content;

                conversationHistory.push({
                    role: 'assistant',
                    content: greeting
                });

                // Increment assistant message counter (first message)
                assistantMessageCount++;
                updateQuestionCounter();

                typingContent.textContent = greeting;
            } catch (error) {
                console.error('Initialization error:', error);
                typingContent.textContent = 'Welcome to the Army FUZE Submission Portal! I\'m here to help assess your technology submission. Let\'s start with your company name and what innovation you\'re bringing to the table.';

                // Still count the fallback greeting
                assistantMessageCount++;
                updateQuestionCounter();
            }
        }

        // Start the conversation when page loads
        initializeChat();

        // Focus input
        messageInput.focus();
    </script>
</body>
</html>
