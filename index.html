<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUZE Submission Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-army-gold: #FFC72C;
            --color-fuze-white: #FFFFFF;
            --color-accent-blue: #0066CC;
            --color-muted-gray: #c5c5c5;
            --color-background: #000000;
            --font-heading: 'Bricolage Grotesque', sans-serif;
            --font-body: 'DM Sans', sans-serif;
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-size: 17px;
            line-height: 1.36em;
            background-color: var(--color-background);
            color: var(--color-muted-gray);
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 700px;
            margin: 0 auto;
            background-color: var(--color-background);
        }

        .chat-header {
            background-color: rgba(0, 0, 0, 0.51);
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .chat-header h1 {
            font-family: var(--font-heading);
            font-size: 28px;
            font-weight: 400;
            letter-spacing: -1px;
            color: var(--color-fuze-white);
        }

        .chat-header h1 .army-text {
            color: var(--color-army-gold);
            font-size: 16px;
            display: block;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--color-army-gold);
            border-radius: 4px;
        }

        .message {
            display: flex;
            gap: var(--spacing-sm);
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: var(--color-army-gold);
            color: var(--color-background);
        }

        .message.assistant .message-avatar {
            background-color: var(--color-accent-blue);
            color: var(--color-fuze-white);
        }

        .message-content {
            background-color: rgba(255, 255, 255, 0.05);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 8px;
            word-wrap: break-word;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message.user .message-content {
            background-color: var(--color-accent-blue);
            color: var(--color-fuze-white);
            border: 1px solid var(--color-accent-blue);
        }

        .message.assistant .message-content {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--color-muted-gray);
        }

        .chat-input-container {
            padding: var(--spacing-md);
            background-color: rgba(0, 0, 0, 0.51);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .chat-input-wrapper {
            display: flex;
            gap: var(--spacing-sm);
            max-width: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 12px var(--spacing-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--color-fuze-white);
            font-family: var(--font-body);
            font-size: 17px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input::placeholder {
            color: rgba(197, 197, 197, 0.5);
        }

        .chat-input:focus {
            border-color: var(--color-accent-blue);
            background-color: rgba(255, 255, 255, 0.08);
        }

        .send-button {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            background-color: var(--color-accent-blue);
            color: var(--color-fuze-white);
            font-family: var(--font-body);
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .send-button:hover {
            background-color: #005a9e;
            transform: scale(1.02);
        }

        .send-button:active {
            transform: scale(0.98);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .mic-button {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--color-fuze-white);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .mic-button.recording {
            background-color: #ff4444;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .mic-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .chat-header {
                height: 60px;
                padding: 0 var(--spacing-sm);
            }

            .chat-header h1 {
                font-size: 22px;
            }

            .chat-messages {
                padding: var(--spacing-sm);
            }

            .message {
                max-width: 90%;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .message-content {
                font-size: 16px;
                padding: var(--spacing-xs) var(--spacing-sm);
            }

            .chat-input-container {
                padding: var(--spacing-sm);
            }

            .chat-input {
                font-size: 16px;
                padding: 10px var(--spacing-sm);
            }

            .send-button {
                padding: 10px var(--spacing-sm);
                font-size: 16px;
            }

            .mic-button {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .send-button {
                padding: 10px 16px;
            }

            .mic-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(197, 197, 197, 0.4);
            text-align: center;
            padding: var(--spacing-lg);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-md);
            color: var(--color-accent-blue);
            opacity: 0.5;
        }

        .empty-state-text {
            font-family: var(--font-heading);
            font-size: 22px;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.5px;
            color: var(--color-muted-gray);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div>
                <h1><span class="army-text">ARMY</span>FUZE Submission Portal</h1>
                <div id="questionCounter" style="font-size: 14px; color: #888; margin-top: 8px;">Question 0 of 10</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸŽ¯</div>
                <div class="empty-state-text">Army FUZE Submission</div>
                <div>Connecting you with an AI assessment specialist...</div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <button class="mic-button" id="micButton" title="Voice input">ðŸŽ¤</button>
                <input
                    type="text"
                    class="chat-input"
                    id="messageInput"
                    placeholder="Type or speak your message..."
                    autocomplete="off"
                >
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');

        // Voice recording variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        let messageCount = 0;
        let conversationHistory = [];
        let submissionData = {};
        let assistantMessageCount = 0; // Track AI responses (questions)
        const MAX_QUESTIONS = 10;
        const questionCounter = document.getElementById('questionCounter');

        // Update question counter display
        function updateQuestionCounter() {
            questionCounter.textContent = `Question ${assistantMessageCount} of ${MAX_QUESTIONS}`;
        }

        // FUZE-specific system prompt for conversational intake
        const SYSTEM_PROMPT = `You are an Army FUZE submission assessment specialist. Your role is to conduct a friendly, conversational interview with innovators submitting technology to the Army FUZE program.

ABOUT ARMY FUZE:
Army FUZE is a venture-capital-style program investing ~$750M/year in defense technology companies through xTech competitions, SBIR/STTR contracts, Technology Maturation Initiative (TMI), and Manufacturing Technology (ManTech) programs. Priority areas include: UAS (drones), counter-drone tech, electronic warfare, and energy resiliency.

YOUR TASK:
Conduct a natural, flowing conversation to understand the innovator's technology submission. You have a strict limit of 10 responses total. Let the conversation flow naturally based on what they share - don't follow a rigid script.

VALUABLE INFORMATION TO GATHER (adapt questions based on context):
- Company identity and background
- Technology description and how it works
- Military applications and defense value
- Commercial market potential
- Development stage and technical maturity (TRL/MRL levels)
- Team capabilities and expertise
- Intellectual property status
- Funding needs and preferred pathways
- Timeline expectations
- Government registrations (SAM.gov, DSIP)

CONVERSATIONAL APPROACH:
- Be warm, encouraging, and professional - this is a conversation, not an interrogation
- Ask 1-2 questions at a time based on their previous answer
- Build on what they tell you - if they mention something interesting, dig deeper
- Use natural language - avoid sounding like a form or checklist
- Acknowledge their answers and show genuine interest
- If they're unsure about something (like TRL), briefly explain it
- Extract information even if they don't use exact terminology
- **CRITICAL: You have exactly 10 responses. Pace yourself accordingly.**
- **By response 8-9, begin wrapping up and preparing your final assessment**

TRL SCALE (for reference when needed):
TRL 1-3: Basic research
TRL 4-6: Proof of concept to prototype
TRL 7-8: Demonstrated in operational environment
TRL 9: Full deployment

ASSESSMENT CRITERIA:
- Technology readiness (TRL/MRL)
- Alignment with FUZE priorities (UAS, counter-UAS, electronic warfare, energy)
- Team capability
- Commercial viability
- Government registration status

FINAL RESPONSE (Response 10):
On your 10th and final response, provide:
1. Thank them for their time
2. Provide capability assessment with scoring (0-10) and recommendation (Strong Fit / Moderate Fit / Needs Development / Not Ready)
3. Let them know their submission has been recorded and the FUZE team will be in touch

Start by warmly welcoming them and asking about their company and innovation.`;

        // Initialize conversation with system prompt
        conversationHistory.push({
            role: 'system',
            content: SYSTEM_PROMPT
        });

        function addMessage(text, sender) {
            // Remove empty state on first message
            if (messageCount === 0) {
                chatMessages.innerHTML = '';
            }
            messageCount++;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'A';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return content; // Return content div for streaming updates
        }

        async function callOpenAI(userMessage) {
            conversationHistory.push({
                role: 'user',
                content: userMessage
            });

            try {
                // Call backend proxy endpoint (keeps API key secure on server)
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: conversationHistory,
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                conversationHistory.push({
                    role: 'assistant',
                    content: assistantMessage
                });

                // Increment assistant message counter
                assistantMessageCount++;
                updateQuestionCounter();

                // Check if we've reached the question limit
                if (assistantMessageCount >= MAX_QUESTIONS) {
                    // Automatically submit after displaying the final message
                    setTimeout(() => {
                        submitConversation();
                    }, 2000); // Wait 2 seconds so user can read final message
                }

                return assistantMessage;
            } catch (error) {
                console.error('OpenAI API Error:', error);
                return `Error: ${error.message}`;
            }
        }

        // Extract structured data from conversation using GPT-4
        async function extractSubmissionData() {
            const conversationText = conversationHistory
                .filter(msg => msg.role !== 'system')
                .map(msg => `${msg.role}: ${msg.content}`)
                .join('\n\n');

            // Use GPT-4 to extract structured data and generate detailed analysis
            const extractionPrompt = `You are a data extraction specialist for Army FUZE submissions. Analyze the following conversation transcript and extract structured data.

CONVERSATION TRANSCRIPT:
${conversationText}

YOUR TASK:
Extract ALL mentioned information from the conversation and provide it in JSON format. For fields not mentioned, use null.

CRITICAL: You must provide these two detailed outputs:
1. "detailed_description": A comprehensive 3-5 paragraph technical description of the technology. Include: how it works, key technical specifications, unique innovations, current development state, and future potential. Be thorough and technical.

2. "ai_assessment": A brutally honest 2-3 paragraph military value analysis. Answer: Is this valuable to the military? Why or why not? What are the strengths and weaknesses? What are the risks? Be direct and critical where needed.

Return ONLY valid JSON in this exact format (no markdown, no backticks):
{
  "company_name": "string or null",
  "contact_email": "string or null",
  "contact_phone": "string or null",
  "company_size": "string or null",
  "company_type": "string or null",
  "technology_name": "string or null",
  "technology_description": "brief 1-sentence summary",
  "detailed_description": "REQUIRED: 3-5 paragraph detailed technical description",
  "technology_category": "string or null",
  "unique_value_proposition": "string or null",
  "military_applications": "string or null",
  "commercial_applications": "string or null",
  "trl_level": number or null,
  "mrl_level": number or null,
  "development_stage": "string or null",
  "ip_status": "string or null",
  "team_size": number or null,
  "team_expertise": "string or null",
  "funding_pathway": "string or null",
  "funding_amount_requested": number or null,
  "previous_fuze_awards": "string or null",
  "previous_fuze_amount": number or null,
  "development_timeline": "string or null",
  "sam_gov_registered": boolean or null,
  "dsip_registered": boolean or null,
  "capability_score": number (0-10) or null,
  "ai_assessment": "REQUIRED: 2-3 paragraph brutally honest military value analysis",
  "recommendation": "Strong Fit / Moderate Fit / Needs Development / Not Ready",
  "conversation_transcript": "${conversationText}",
  "timestamp": "${new Date().toISOString()}"
}`;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            { role: 'system', content: 'You are a data extraction specialist. Return only valid JSON, no markdown formatting.' },
                            { role: 'user', content: extractionPrompt }
                        ],
                        max_tokens: 2000,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error('Extraction failed');
                }

                const data = await response.json();
                const extracted = data.choices[0].message.content;

                // Parse JSON response
                const jsonMatch = extracted.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error('No JSON found in response');
                }
            } catch (error) {
                console.error('Extraction error:', error);
                // Fallback to basic data
                return {
                    conversation_transcript: conversationText,
                    timestamp: new Date().toISOString()
                };
            }
        }

        // Submit conversation to database
        async function submitConversation() {
            try {
                // Disable input
                sendButton.disabled = true;
                messageInput.disabled = true;
                micButton.disabled = true;

                // Show processing message
                addMessage('ðŸ“‹ Analyzing conversation and extracting data...', 'assistant');

                // Extract structured data using AI
                const submissionData = await extractSubmissionData();

                // Show submission message
                addMessage('ðŸ’¾ Submitting to FUZE database...', 'assistant');

                const response = await fetch('/api/submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submissionData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit');
                }

                const result = await response.json();

                // Show success message
                addMessage(`âœ… Submission complete! Your submission ID is ${result.submissionId}. The FUZE team will review your information and be in touch soon. Thank you!`, 'assistant');

            } catch (error) {
                console.error('Submission error:', error);
                addMessage('âŒ There was an error submitting your information. Please contact support@fuze.army.mil', 'assistant');
            }
        }

        // Voice recording functions
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeAudio(audioBlob);

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                micButton.classList.add('recording');
                micButton.title = 'Stop recording';
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                micButton.classList.remove('recording');
                micButton.title = 'Voice input';
            }
        }

        async function transcribeAudio(audioBlob) {
            micButton.disabled = true;
            messageInput.placeholder = 'Transcribing...';

            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');

                // Call backend proxy endpoint (keeps API key secure on server)
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Transcription failed');
                }

                const data = await response.json();
                messageInput.value = data.text;
                messageInput.focus();
            } catch (error) {
                console.error('Transcription error:', error);
                alert('Failed to transcribe audio. Please try again.');
            } finally {
                micButton.disabled = false;
                messageInput.placeholder = 'Type or speak your message...';
            }
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            // Disable input while processing
            sendButton.disabled = true;
            messageInput.disabled = true;
            micButton.disabled = true;

            addMessage(text, 'user');
            messageInput.value = '';

            // Show typing indicator
            const typingContent = addMessage('Thinking...', 'assistant');

            // Call OpenAI API
            const response = await callOpenAI(text);

            // Update message with actual response
            typingContent.textContent = response;

            // Re-enable input
            sendButton.disabled = false;
            messageInput.disabled = false;
            micButton.disabled = false;
            messageInput.focus();
        }

        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Microphone button - toggle recording
        micButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // Initialize with AI greeting
        async function initializeChat() {
            // Show typing indicator
            const typingContent = addMessage('Initializing...', 'assistant');

            try {
                // Call backend proxy endpoint (keeps API key secure on server)
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: conversationHistory,
                        max_tokens: 300,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to initialize');
                }

                const data = await response.json();
                const greeting = data.choices[0].message.content;

                conversationHistory.push({
                    role: 'assistant',
                    content: greeting
                });

                // Increment assistant message counter (first message)
                assistantMessageCount++;
                updateQuestionCounter();

                typingContent.textContent = greeting;
            } catch (error) {
                console.error('Initialization error:', error);
                typingContent.textContent = 'Welcome to the Army FUZE Submission Portal! I\'m here to help assess your technology submission. Let\'s start with your company name and what innovation you\'re bringing to the table.';

                // Still count the fallback greeting
                assistantMessageCount++;
                updateQuestionCounter();
            }
        }

        // Start the conversation when page loads
        initializeChat();

        // Focus input
        messageInput.focus();
    </script>
</body>
</html>
